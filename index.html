<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ATRM - Tu Sindicato | Limpieza Viaria e Interiores RegiÃ³n de Murcia</title>
  <meta name="description" content="Sindicato ATRM. Defensa de derechos laborales, convenios colectivos, tabla salarial 2026, calculadora de salarios y trÃ¡mites para trabajadores.">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FF6B35">
  <link rel="stylesheet" href="css/professional-theme.css">
  <link rel="stylesheet" href="css/preloader.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Poppins:wght@700;800&display=swap" rel="stylesheet">
  <style>
    /* Legacy styles - keeping for compatibility */
    :root{ --primary:#FF6B35; --secondary:#FF8C42; --accent:#FFA726; --dark:#2C3E50; --light:#FFFFFF; }

    /* Carrusel noticias */
    .news-carousel{background:linear-gradient(135deg,var(--primary),var(--primary-dark) 50%,var(--secondary));color:#fff;padding:12px 0;box-shadow:var(--shadow-md)}
    .carousel-wrap{max-width:1100px;margin:0 auto;position:relative;padding:0 48px}
    .slides{display:flex;overflow:hidden;scroll-behavior:smooth}
    .slide{min-width:100%;padding:12px 0}
    .slide a{color:#fff;text-decoration:none;transition:opacity 0.2s}
    .slide a:hover{opacity:0.9}
    .title{font-weight:800;font-size:1.05rem}
    .dots{display:flex;gap:8px;justify-content:center;margin-top:8px}
    .dot{width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,.3);cursor:pointer;transition:all 0.3s}
    .dot:hover{background:rgba(255,255,255,.5)}
    .dot.active{background:#fff;width:24px;border-radius:5px}
    .arrow{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.2);border:none;color:#fff;width:40px;height:40px;border-radius:50%;cursor:pointer;transition:all 0.3s;backdrop-filter:blur(4px)}
    .arrow:hover{background:rgba(255,255,255,.35);transform:translateY(-50%) scale(1.1)}
    .prev{left:10px}.next{right:10px}

    .hero{max-width:1100px;margin:40px auto;padding:0 20px;display:grid;grid-template-columns:1.1fr .9fr;gap:32px}
    .hero .left{padding:40px}
    .badge{display:inline-block;background:linear-gradient(90deg,var(--secondary),var(--accent));color:#4e2b00;padding:8px 14px;border-radius:999px;font-size:13px;font-weight:700;box-shadow:var(--shadow-sm)}
    h1{margin:16px 0 18px;font-size:clamp(2rem,5vw,3rem);line-height:1.2}
    .cta{display:flex;gap:14px;margin-top:24px;flex-wrap:wrap}
    .news{padding:24px}
    .grid{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:24px;padding:0 20px 60px}

    @media(max-width:900px){
      .hero{grid-template-columns:1fr;gap:24px}
      .grid{grid-template-columns:1fr;padding:0 16px 40px}
      .carousel-wrap{padding:0 40px}
    }
  </style>
</head>
<body>
  <!-- Preloader / Splash Screen -->
  <div id="preloader">
    <canvas id="preloader-particles"></canvas>
    <div class="preloader-content">
      <div class="preloader-logo shine-effect">ATRM</div>
      <div class="preloader-subtitle">Tu Sindicato</div>
      <div class="preloader-spinner"></div>
      <div class="preloader-loading">Cargando...</div>
    </div>
  </div>
  
  <header class="premium-header">
    <div class="header-content">
      <a href="index.html" class="logo">ğŸ”¥ ATRM Â· Tu Sindicato</a>
      <nav class="menu">
        <a href="#inicio">Inicio</a>
        <a href="#convenio">Viaria</a>
        <a href="interiores.html">Interiores</a>
        <a href="salaries.html">Salarios</a>
        <a href="conceptos_2026.html">Conceptos 2026</a>
        <a href="tramites.html">TrÃ¡mites</a>
        <a href="festivos.html">Festivos</a>
        <a href="generador.html">ğŸ“ Docs</a>
        <a href="podcasts.html">ğŸ™ï¸ Podcasts</a>
        <a href="#contacto">Contacto</a>
      </nav>
    </div>
  </header>

  <section class="news-carousel" id="newsTop">
    <div class="carousel-wrap">
      <button class="arrow prev" aria-label="Anterior" onclick="prevSlide()">â€¹</button>
      <div class="slides" id="slides">
        <div class="slide">
          <a href="https://www.facebook.com/share/v/1GpuUm99s3/" target="_blank" rel="noopener">
            <span class="title">ğŸ—ºï¸ Limpieza MazarrÃ³n</span> â€” Ver noticia en Facebook
          </a>
        </div>
        <div class="slide" id="slideDynamic1"></div>
        <div class="slide" id="slideDynamic2"></div>
      </div>
      <button class="arrow next" aria-label="Siguiente" onclick="nextSlide()">â€º</button>
      <div class="dots" id="dots"></div>
    </div>
  </section>

  <main id="inicio" class="hero">
    <section class="left card premium-card">
      <span class="badge">âœ¨ Limpieza PÃºblica Viaria Â· RegiÃ³n de Murcia</span>
      <h1>Defendemos tus derechos con cercanÃ­a y resultados</h1>

      <!-- Buscador Global Injectado por JS -->
      <div class="global-search-container"></div>
      
      <p>ATRM es el sindicato de referencia para los trabajadores de limpieza viaria y servicios municipales en la RegiÃ³n de Murcia.</p>
      <div class="cta">
        <a class="btn btn-premium" href="#convenio">Ver Convenio</a>
        <a class="btn btn-premium btn-outline" href="tramites.html">TrÃ¡mites</a>
      </div>
    </section>
    <aside class="card premium-card news" id="noticias">
      <h3 style="color:var(--primary)">ğŸ”¥ Ãšltimas noticias</h3>
      <div id="newsList"></div>
    </aside>
  </main>

  <section id="convenio" class="grid">
    <div class="card premium-card" style="padding:20px">
      <h3 style="color:var(--primary)">ğŸ“‹ Convenio Colectivo 2024â€“2027</h3>
      <p id="convenioResumen"></p>
      <ul id="convenioDatos"></ul>
      <div style="margin-top:16px">
        <p style="font-weight:600;margin-bottom:8px">ğŸ’¬ Asistente IA del convenio:</p>
        <input id="preguntaIAInline" placeholder="Escribe tu pregunta (ej: tabla salarial, permisos...)" style="width:100%;padding:12px;border:1px solid #ffd2b5;border-radius:10px;font-size:15px;margin-bottom:10px" />
        <button class="btn btn-premium" onclick="preguntarIAInline()">ğŸ¤– Preguntar</button>
      </div>
      <div id="vistaRespuesta" style="display:none;margin-top:16px;padding:16px;background:#fff7f0;border-radius:10px;border:1px solid #ffd2b5"></div>
    </div>
    <div class="card premium-card" style="padding:20px">
      <h3 style="color:var(--primary)">ğŸ—ºï¸ Ãmbito de aplicaciÃ³n</h3>
      <p id="ambito"></p>
    </div>
    <div class="card premium-card" style="padding:20px">
      <h3 style="color:var(--primary)">ğŸ“š DocumentaciÃ³n</h3>
      <p>Accede a la tabla salarial y calendario de festivos 2026.</p>
      <a class="btn btn-premium btn-outline" href="festivos.html">ğŸ“… Ver festivos 2026</a>
    </div>
    <div class="card premium-card" style="padding:20px;grid-column:1/-1">
      <h3 style="color:var(--primary)">ğŸ“‚ Descarga de documentos</h3>
      <div style="display:flex;flex-wrap:wrap;gap:16px 24px;align-items:center">
        <a class="btn" href="assets/calendarios/calendario-descansos-2026.png" download="calendario-descansos-atrm-2026.png">ğŸ“¥ Calendario de descansos 2026</a>
        <a class="btn alt" href="salaries.html" target="_blank">ğŸ“Š Tabla Salarial 2026</a>
        <a class="btn" href="conceptos_2026.html" target="_blank">ğŸ“œ Conceptos 2026</a>
        <a class="btn" href="tabla_salarial_2026_pdf.html" target="_blank">ğŸ“„ PDF Tabla 2026</a>
        <a class="btn" href="assets/convenio_viaria.pdf" download>ğŸ“„ Convenio completo (BORM nÂº 599)</a>
      </div>
      <div style="margin-top:10px;font-size:13px;color:#2C3E50">Puedes descargar el calendario, la tabla salarial y el texto oficial del convenio sectorial.</div>
    </div>
  </section>

  <section id="contacto" class="grid">
    <div class="card" style="padding:20px;grid-column:1/-1">
      <h3>ğŸš¨ Denuncia anÃ³nima</h3>
      <form id="formDenuncia" autocomplete="off" style="display:flex;flex-wrap:wrap;gap:16px;flex-direction:column">
        <textarea name="denuncia" placeholder="Describe la situaciÃ³n o irregularidad laboral (no pongas datos personales si quieres mantener el anonimato)" required rows="4" style="padding:10px;border-radius:8px;border:1px solid #ffd2b5;font-size:16px"></textarea>
        <button type="submit" class="btn" style="background:#e74c3c">Enviar denuncia anÃ³nima</button>
        <div id="msgDenuncia" style="margin-top:8px;font-size:15px;display:none"></div>
      </form>
      <div style="font-size:13px;color:#2C3E50;margin-top:8px">Esta denuncia es confidencial y solo serÃ¡ revisada por el sindicato. No se almacena ningÃºn dato personal salvo que lo incluyas voluntariamente.</div>
    </div>
    <div class="card" style="padding:20px">
      <h3>ğŸ“ Contacto</h3>
      <p><strong>TelÃ©fono principal:</strong> 968 30 00 37 (Lunes Tarde)<br>
      <strong>TelÃ©fono:</strong> 658 876 771<br>
      <strong>FAX:</strong> 968 30 00 37<br>
      <strong>Email:</strong> <a href="mailto:info@atrm-sindicato.es" style="color:var(--primary)">info@atrm-sindicato.es</a><br>
      <strong>DirecciÃ³n:</strong> C/ Carril La Torre, 27 Bajo<br>30006 Puente Tocinos (MURCIA)</p>
    </div>
    <div class="card" style="padding:20px">
      <h3>ğŸ“± Contactos directos</h3>
      <p style="line-height:1.8">
        <strong>AndrÃ©s AnduÃ¡:</strong> 696 446 421<br>
        <strong>Santiago Oliva:</strong> 609 314 582<br>
        <strong>Francisco SÃ¡nchez (Suave):</strong> 628 304 954<br>
        <strong>Mesa:</strong> 658 876 771<br><br>
        <strong>Otros telÃ©fonos:</strong><br>
        649 549 495<br>
        616 973 186 Â· 653 878 579<br>
        635 457 212
      </p>
    </div>
    <div class="card" style="padding:20px">
      <h3>ğŸ• Horario de atenciÃ³n</h3>
      <p>Lunes a Viernes: 09:00 - 14:00<br>
      Lunes (Tarde): 16:00 - 20:00</p>
    </div>
    <div class="card" style="padding:20px;grid-column:1/-1;text-align:center">
      <h3>ğŸ”— Contacto y redes sociales</h3>
      <div style="display:flex;gap:18px;justify-content:center;flex-wrap:wrap;margin-bottom:10px">
        <a href="https://wa.me/34658876771?text=Hola%20ATRM%2C%20quisiera%20informaci%C3%B3n" target="_blank" class="btn" style="background:#25D366"><span style="font-size:20px">ğŸŸ¢</span> WhatsApp</a>
        <a href="mailto:info@atrm-sindicato.es" class="btn alt" style="background:#fff;color:#FF6B35;border:2px solid #FF6B35"><span style="font-size:20px">âœ‰ï¸</span> Email</a>
        <a id="fbShareBtn" href="#" target="_blank" class="btn" style="background:#4267B2"><span style="font-size:20px">ğŸ”µ</span> Facebook</a>
      </div>
      <script>document.addEventListener('DOMContentLoaded', function() { document.getElementById('fbShareBtn').href = 'https://www.facebook.com/share.php?u=' + encodeURIComponent(window.location.origin + window.location.pathname); });</script>
      <div style="font-size:13px;color:#2C3E50">Contacta por WhatsApp, correo o comparte la web en Facebook.</div>
    </div>
    <div class="card" style="padding:20px;grid-column:1/-1">
      <h3>âœ‰ï¸ Formulario de contacto</h3>
      <form id="contactForm" autocomplete="on" style="display:flex;flex-wrap:wrap;gap:16px;flex-direction:column">
        <div style="display:flex;gap:16px;flex-wrap:wrap">
          <input name="nombre" type="text" placeholder="Nombre y apellidos" required style="flex:1;padding:10px;border-radius:8px;border:1px solid #ffd2b5;font-size:16px">
          <input name="email" type="email" placeholder="Correo electrÃ³nico" required style="flex:1;padding:10px;border-radius:8px;border:1px solid #ffd2b5;font-size:16px">
          <input name="telefono" type="tel" placeholder="TelÃ©fono (opcional)" style="flex:1;padding:10px;border-radius:8px;border:1px solid #ffd2b5;font-size:16px">
        </div>
        <textarea name="mensaje" placeholder="Escribe tu consulta o mensaje" required rows="4" style="padding:10px;border-radius:8px;border:1px solid #ffd2b5;font-size:16px"></textarea>
        <button type="submit" class="btn">Enviar mensaje</button>
        <div id="formMsg" style="margin-top:8px;font-size:15px;display:none"></div>
      </form>
    </div>
  </section>



  <script>
  // Formulario de denuncia anÃ³nima -> backend Resend
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('formDenuncia');
    if (!form) return;

    form.addEventListener('submit', async function(e) {
      e.preventDefault();

      const msg = document.getElementById('msgDenuncia');
      const btn = form.querySelector('button[type="submit"]');
      const denuncia = form.querySelector('textarea[name="denuncia"]').value.trim();

      if (!denuncia) {
        msg.textContent = 'âš ï¸ Describe la situaciÃ³n antes de enviar.';
        msg.style.color = '#e67e22';
        msg.style.display = 'block';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Enviando...';
      msg.textContent = 'ğŸ“¤ Enviando denuncia...';
      msg.style.color = '#3498db';
      msg.style.display = 'block';

      try {
        const response = await fetch('/api/denuncia', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ texto: denuncia })
        });

        const data = await response.json().catch(() => ({}));

        if (!response.ok || !data?.success) {
          throw new Error(data?.error || 'No se pudo enviar la denuncia');
        }

        msg.textContent = 'âœ… Â¡Denuncia enviada correctamente! El sindicato la revisarÃ¡ de forma confidencial.';
        msg.style.color = '#27ae60';
        form.reset();
        setTimeout(() => { msg.style.display = 'none'; }, 8000);
      } catch (error) {
        console.error('âŒ Error enviando denuncia:', error);
        msg.textContent = 'âŒ Error al enviar. Por favor, contacta directamente: 968 30 00 37 o info@atrm-sindicato.es';
        msg.style.color = '#e74c3c';
        setTimeout(() => { msg.style.display = 'none'; }, 10000);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Enviar denuncia anÃ³nima';
      }
    });
  });
  // Cargar IA mejorada para el asistente del convenio (Viaria)
  const scriptIA = document.createElement('script');
  scriptIA.src = 'js/ia_nueva.js';
  document.head.appendChild(scriptIA);
  
  // Cargar IA para convenio de Interiores
  const scriptIAInteriores = document.createElement('script');
  scriptIAInteriores.src = 'js/ia_interiores.js';
  document.head.appendChild(scriptIAInteriores);

  // Nueva funciÃ³n inline para preguntas en la misma pÃ¡gina
  async function preguntarIAInline() {
    const input = document.getElementById('preguntaIAInline');
    const pregunta = input.value.trim();
    const vistaDiv = document.getElementById('vistaRespuesta');

    if (!pregunta) {
      vistaDiv.innerHTML = '<div style="color:#e67e22">âš ï¸ Por favor, escribe una pregunta.</div>';
      vistaDiv.style.display = 'block';
      return;
    }

    vistaDiv.style.display = 'block';
    vistaDiv.innerHTML = '<div style="padding:10px;display:flex;align-items:center;gap:10px;color:#555;">âœï¸ Escribiendo...</div>';

    try {
      console.log('ğŸ” Pregunta IA Inline:', pregunta);
      const respuesta = await window.iaContextual.responder(pregunta);
      console.log('âœ… Respuesta recibida:', respuesta);
      
      const htmlLimpio = limpiarMarkdown(respuesta);
      vistaDiv.innerHTML = htmlLimpio;
      
      // AÃ±adir sugerencias si hay
      if (window.iaContextual && typeof window.iaContextual.obtenerSugerencias === 'function') {
        const sugs = window.iaContextual.obtenerSugerencias();
        if (sugs && sugs.length) {
          const sugHTML = '<div style="margin-top:12px;padding-top:12px;border-top:1px solid #ffd2b5"><div style="font-weight:600;margin-bottom:8px;font-size:14px">ğŸ’¬ Preguntas relacionadas:</div><div style="display:flex;flex-wrap:wrap;gap:8px">';
          const chips = sugs.map(s => {
            const texto = typeof s === 'string' ? s : (s.titulo || s);
            return `<button onclick="document.getElementById('preguntaIAInline').value='${texto}'; preguntarIAInline();" style="background:#fff;border:1px solid #ffd2b5;color:#2C3E50;padding:6px 12px;border-radius:999px;cursor:pointer;font-size:13px">${texto}</button>`;
          }).join('');
          vistaDiv.innerHTML += sugHTML + chips + '</div></div>';
        }
      }
    } catch (error) {
      console.error('âŒ Error:', error);
      vistaDiv.innerHTML = '<div style="color:#e74c3c">âŒ Error procesando la pregunta. Intenta de nuevo.</div>';
    }
  }

  // Convertir Markdown simple a HTML
  function limpiarMarkdown(texto) {
    if (!texto) return '';
    return texto
      .replace(/~~(.*?)~~/g, '<s>$1</s>') // tachado ~~texto~~ â†’ <s>texto</s>
      .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>') // ***texto*** â†’ negrita+cursiva
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>') // **texto** â†’ negrita
      .replace(/\*(.+?)\*/g, '<em>$1</em>') // *texto* â†’ cursiva
      .replace(/^### (.+)$/gm, '<h3>$1</h3>') // ### tÃ­tulo
      .replace(/^## (.+)$/gm, '<h2>$1</h2>') // ## tÃ­tulo
      .replace(/^# (.+)$/gm, '<h1>$1</h1>') // # tÃ­tulo
      .replace(/\n/g, '<br>'); // saltos de lÃ­nea
  }

  // Listener para Enter en input inline
  document.addEventListener('DOMContentLoaded', function(){
    const inputInline = document.getElementById('preguntaIAInline');
    if (inputInline) {
      inputInline.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') preguntarIAInline();
      });
    }
  });
  // Formulario de contacto ATRM
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('contactForm');
    if (form) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        // AquÃ­ se puede integrar el envÃ­o real por email (backend o servicio externo)
        // Por ahora solo muestra confirmaciÃ³n visual
        const msg = document.getElementById('formMsg');
        msg.textContent = 'Â¡Mensaje enviado correctamente! Nos pondremos en contacto contigo pronto.';
        msg.style.display = 'block';
        form.reset();
        setTimeout(()=>{msg.style.display='none';}, 6000);
      });
    }
  });
    // Carga de noticias para las slides dinÃ¡micas
    document.addEventListener('DOMContentLoaded', async ()=>{
      const d1 = document.getElementById('slideDynamic1');
      const d2 = document.getElementById('slideDynamic2');
      try {
        let noticias = [];
        try {
          const response = await fetch('/api/noticias');
          if (!response.ok) throw new Error('API no disponible');
          const data = await response.json();
          noticias = data.noticias || [];
        } catch (error) {
          const response = await fetch('data/noticias.json');
          const data = await response.json();
          noticias = data.noticias || [];
        }

        noticias = noticias.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        const n1 = noticias[0];
        const n2 = noticias[1];

        d1.innerHTML = n1
          ? `<a href="${n1.url}" target="_blank" rel="noopener"><span class="title">ğŸ“° ${n1.titulo}</span>${n1.videoUrl ? ' â€” ğŸ¥ Video disponible' : ''}</a>`
          : '<span class="title">ğŸ“° ATRM</span> â€” Calendario laboral 2026 disponible';
        d2.innerHTML = n2
          ? `<a href="${n2.url}" target="_blank" rel="noopener"><span class="title">ğŸ“¢ ${n2.titulo}</span>${n2.videoUrl ? ' â€” ğŸ¥ Video disponible' : ''}</a>`
          : '<span class="title">ğŸ“¢ ATRM</span> â€” TrÃ¡mites y guÃ­as paso a paso actualizados';
      } catch (error) {
        d1.innerHTML = '<span class="title">ğŸ“° ATRM</span> â€” Calendario laboral 2026 disponible';
        d2.innerHTML = '<span class="title">ğŸ“¢ ATRM</span> â€” TrÃ¡mites y guÃ­as paso a paso actualizados';
      }
      initDots();
    });
    let idx=0; function nextSlide(){ idx=(idx+1)%3; document.getElementById('slides').scrollTo({left:idx*document.getElementById('slides').clientWidth,behavior:'smooth'}); setActiveDot(); }
    function prevSlide(){ idx=(idx+2)%3; document.getElementById('slides').scrollTo({left:idx*document.getElementById('slides').clientWidth,behavior:'smooth'}); setActiveDot(); }
    function initDots(){ const dots=document.getElementById('dots'); for(let i=0;i<3;i++){ const b=document.createElement('div'); b.className='dot'+(i===0?' active':''); b.onclick=()=>{ idx=i; nextSlide(); }; dots.appendChild(b);} }
    function setActiveDot(){ const dots=[...document.querySelectorAll('.dot')]; dots.forEach((d,i)=>d.classList.toggle('active',i===idx)); }
  </script>
  <script src="js/noticias.js"></script>
  <script src="js/modo_oscuro.js"></script>
  <script src="js/calculadora_vacaciones.js"></script>
  <script src='js/bottom-nav.js'></script>  <script src="js/global-search.js"></script></body>
  <!-- Chat flotante estilo WhatsApp -->
  <div id="chat-float-btn" style="position:fixed;bottom:28px;right:28px;z-index:9999;">
    <button onclick="abrirChatATRM()" style="background:#25D366;color:#fff;border:none;border-radius:50%;width:60px;height:60px;box-shadow:0 4px 16px rgba(0,0,0,0.18);font-size:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;">
      ğŸ’¬
    </button>
  </div>
  <div id="chat-atm-window" style="display:none;position:fixed;bottom:100px;right:32px;width:340px;max-width:95vw;background:#fff;border-radius:18px;box-shadow:0 8px 32px rgba(0,0,0,0.18);z-index:10000;overflow:hidden;flex-direction:column;">
    <div style="background:#25D366;color:#fff;padding:14px 18px;font-weight:700;display:flex;align-items:center;justify-content:space-between;gap:8px">
      <span>ATRM Chat</span>
      <div style="display:flex;gap:6px;align-items:center">
        <select id="tipoConvenioChat" onchange="cambiarConvenioChat()" style="background:#fff;color:#222;font-size:12px;padding:4px 8px;border:none;border-radius:6px;font-weight:600">
          <option value="viaria">ğŸš› Viaria</option>
          <option value="interiores">ğŸ¢ Interiores</option>
        </select>
      </div>
      <button onclick="cerrarChatATRM()" style="background:none;border:none;color:#fff;font-size:22px;cursor:pointer;">Ã—</button>
    </div>
    <div id="chat-messages" style="padding:14px;height:260px;overflow-y:auto;background:#f7f7f7;font-size:15px;display:flex;flex-direction:column;gap:8px;"></div>
    <form id="chat-form" style="display:flex;border-top:1px solid #eee;background:#fff">
      <input id="chat-input" type="text" placeholder="Escribe tu pregunta..." autocomplete="off" style="flex:1;padding:10px 12px;border:none;font-size:15px;border-radius:0 0 0 18px;outline:none">
      <button type="submit" style="background:#25D366;color:#fff;border:none;padding:0 18px;font-size:18px;cursor:pointer;border-radius:0 0 18px 0;">â¤</button>
    </form>
  </div>
  <script>
    // Mensaje de bienvenida humano
    let chatBienvenidaMostrada = false;
    let convenioActual = 'viaria'; // Por defecto Viaria
    
    function abrirChatATRM(){
      document.getElementById('chat-atm-window').style.display = 'flex';
      setTimeout(()=>{
        const el = document.getElementById('chat-input');
        if(el) el.focus();
      }, 200);
      if (!chatBienvenidaMostrada) {
        const tipoConvenio = document.getElementById('tipoConvenioChat').value;
        const nombreConvenio = tipoConvenio === 'viaria' ? 'Limpieza PÃºblica Viaria' : 'Limpieza de Edificios y Locales';
        agregarMensajeChat(`ğŸ‘‹ Â¡Hola! Soy ATRM. Estoy configurado para el convenio de ${nombreConvenio}. Â¿En quÃ© puedo ayudarte?`, 'bot');
        chatBienvenidaMostrada = true;
      }
    }
    
    function cerrarChatATRM(){
      document.getElementById('chat-atm-window').style.display = 'none';
    }
    
    function cambiarConvenioChat(){
      const tipoConvenio = document.getElementById('tipoConvenioChat').value;
      convenioActual = tipoConvenio;
      const nombreConvenio = tipoConvenio === 'viaria' ? 'Limpieza PÃºblica Viaria' : 'Limpieza de Edificios y Locales';
      
      // Limpiar mensajes y mostrar cambio
      const chat = document.getElementById('chat-messages');
      chat.innerHTML = '';
      agregarMensajeChat(`âœ… Cambiado a convenio de ${nombreConvenio}. Â¿En quÃ© puedo ayudarte?`, 'bot');
      chatBienvenidaMostrada = true;
    }
    // LÃ³gica de chat
    document.getElementById('chat-form').addEventListener('submit', async function(e){
      e.preventDefault();
      const input = document.getElementById('chat-input');
      const msg = input.value.trim();
      if(!msg) return;
      agregarMensajeChat(msg, 'user');
      input.value = '';
      // Frase de espera humana
      const frasesEspera = [
        'Un momento, estoy buscando la informaciÃ³n... ğŸ¤”',
        'DÃ©jame revisar el convenio para darte la mejor respuesta...',
        'Consultando la base de datos sindical...'
      ];
      const frase = frasesEspera[Math.floor(Math.random()*frasesEspera.length)];
      agregarMensajeChat(frase, 'bot');
      // Esperar a que la IA estÃ© cargada y usar la correcta segÃºn el convenio
      const tipoConvenio = document.getElementById('tipoConvenioChat').value;
      const iaActual = tipoConvenio === 'interiores' ? window.iaInteriores : window.iaContextual;
      
      if (!iaActual) {
        await new Promise(resolve => {
          const check = setInterval(() => {
            const ia = tipoConvenio === 'interiores' ? window.iaInteriores : window.iaContextual;
            if (ia) {
              clearInterval(check);
              resolve();
            }
          }, 100);
        });
      }
      
      const iaFinal = tipoConvenio === 'interiores' ? window.iaInteriores : window.iaContextual;
      const respuesta = await iaFinal.responder(msg);
      quitarUltimoMensajeBot();
      agregarMensajeChat(respuesta, 'bot');
      
      // Insertar sugerencias de la IA correcta
      const tipoConvenioSugerencias = document.getElementById('tipoConvenioChat').value;
      const iaSugerencias = tipoConvenioSugerencias === 'interiores' ? window.iaInteriores : window.iaContextual;
      if (iaSugerencias) insertarSugerenciasChat();
    });
    function agregarMensajeChat(texto, tipo){
      const chat = document.getElementById('chat-messages');
      const div = document.createElement('div');
      div.style.maxWidth = '85%';
      div.style.alignSelf = tipo==='user'?'flex-end':'flex-start';
      div.style.background = tipo==='user'?'#e1ffc7':'#fff';
      div.style.color = '#222';
      div.style.padding = '8px 12px';
      div.style.borderRadius = tipo==='user'?'16px 16px 4px 16px':'16px 16px 16px 4px';
      div.style.boxShadow = '0 2px 8px rgba(0,0,0,0.04)';
      div.innerHTML = tipo === 'bot' ? limpiarMarkdown(texto) : texto;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
    function quitarUltimoMensajeBot(){
      const chat = document.getElementById('chat-messages');
      for(let i=chat.children.length-1;i>=0;i--){
        if(chat.children[i].style.alignSelf==='flex-start'){
          chat.removeChild(chat.children[i]);
          break;
        }
      }
    }
    function insertarSugerenciasChat(){
      const tipoConvenio = document.getElementById('tipoConvenioChat').value;
      const iaActual = tipoConvenio === 'interiores' ? window.iaInteriores : window.iaContextual;
      
      if (!iaActual || typeof iaActual.obtenerSugerencias !== 'function') return;
      const sugs = iaActual.obtenerSugerencias();
      if (!sugs || !sugs.length) return;
      const cont = document.createElement('div');
      cont.style.maxWidth = '85%';
      cont.style.alignSelf = 'flex-start';
      cont.style.background = '#fff';
      cont.style.color = '#222';
      cont.style.padding = '8px 12px';
      cont.style.borderRadius = '16px 16px 16px 4px';
      cont.style.boxShadow = '0 2px 8px rgba(0,0,0,0.04)';
      const principalScore = (iaActual.ultimosResultados && iaActual.ultimosResultados[0]?.score) || 0;
      const label = document.createElement('div');
      label.textContent = principalScore < 6 ? 'TambiÃ©n podrÃ­an interesarte:' : 'Temas relacionados:';
      label.style.fontWeight = '700';
      label.style.margin = '0 0 6px 0';
      const wrap = document.createElement('div');
      wrap.style.display = 'flex';
      wrap.style.flexWrap = 'wrap';
      wrap.style.gap = '6px';
      sugs.forEach(s => {
        const b = document.createElement('button');
        b.type = 'button';
        b.textContent = s.titulo;
        b.style.background = '#eaf6ff';
        b.style.border = '1px solid #bfe0ff';
        b.style.color = '#1f3b57';
        b.style.padding = '6px 10px';
        b.style.borderRadius = '999px';
        b.style.cursor = 'pointer';
        b.style.fontSize = '13px';
        b.onclick = () => {
          const inp = document.getElementById('chat-input');
          inp.value = s.titulo;
          document.getElementById('chat-form').dispatchEvent(new Event('submit', { bubbles:true, cancelable:true }));
        };
        wrap.appendChild(b);
      });
      cont.appendChild(label);
      cont.appendChild(wrap);
      const chat = document.getElementById('chat-messages');
      chat.appendChild(cont);
      chat.scrollTop = chat.scrollHeight;
    }
  </script>
  <script>
    function abrirChatATRM(){
      document.getElementById('chat-atm-window').style.display = 'flex';
      setTimeout(()=>{
        const el = document.getElementById('chat-input');
        if(el) el.focus();
      }, 200);
    }
    function cerrarChatATRM(){
      document.getElementById('chat-atm-window').style.display = 'none';
    }

    function agregarMensajeChat(mensaje, remitente, guardar = true) {
      const chatMessages = document.getElementById('chat-messages');
      const msgDiv = document.createElement('div');
      msgDiv.style.maxWidth = '85%';
      msgDiv.style.alignSelf = remitente === 'user' ? 'flex-end' : 'flex-start';
      msgDiv.style.background = remitente === 'user' ? '#e1ffc7' : '#fff';
      msgDiv.style.color = '#222';
      msgDiv.style.padding = '8px 12px';
      msgDiv.style.borderRadius = remitente === 'user' ? '16px 16px 4px 16px' : '16px 16px 16px 4px';
      msgDiv.style.boxShadow = '0 2px 8px rgba(0,0,0,0.04)';
      msgDiv.innerHTML = remitente === 'bot' ? limpiarMarkdown(mensaje) : mensaje;
      
      // AÃ±adir botones de feedback solo para mensajes del bot (no escribiendo...)
      if (remitente === 'bot' && !mensaje.includes('âœï¸ Escribiendo')) {
        const feedbackDiv = document.createElement('div');
        feedbackDiv.style.marginTop = '6px';
        feedbackDiv.style.display = 'flex';
        feedbackDiv.style.gap = '8px';
        feedbackDiv.style.fontSize = '18px';
        
        const btnLike = document.createElement('button');
        btnLike.innerHTML = 'ğŸ‘';
        btnLike.style.border = 'none';
        btnLike.style.background = 'transparent';
        btnLike.style.cursor = 'pointer';
        btnLike.style.fontSize = '18px';
        btnLike.style.padding = '4px 8px';
        btnLike.style.opacity = '0.6';
        btnLike.onclick = () => registrarFeedback('like', feedbackDiv);
        
        const btnDislike = document.createElement('button');
        btnDislike.innerHTML = 'ğŸ‘';
        btnDislike.style.border = 'none';
        btnDislike.style.background = 'transparent';
        btnDislike.style.cursor = 'pointer';
        btnDislike.style.fontSize = '18px';
        btnDislike.style.padding = '4px 8px';
        btnDislike.style.opacity = '0.6';
        btnDislike.onclick = () => registrarFeedback('dislike', feedbackDiv);
        
        feedbackDiv.appendChild(btnLike);
        feedbackDiv.appendChild(btnDislike);
        msgDiv.appendChild(feedbackDiv);
      }
      
      chatMessages.appendChild(msgDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      if (guardar) {
        guardarHistorialChat();
      }
      return msgDiv;
    }
    
    function registrarFeedback(tipo, feedbackDiv) {
      feedbackDiv.innerHTML = '<span style="font-size:13px;color:#2C3E50;">âœ“ Gracias por tu feedback</span>';
      // AquÃ­ se puede aÃ±adir lÃ³gica para enviar el feedback a un servidor
    }

    async function enviarPreguntaChat(pregunta) {
      if (!pregunta.trim()) return;

      agregarMensajeChat(pregunta, 'user');
      const thinkingMsg = agregarMensajeChat('âœï¸ Escribiendo...', 'bot', false); // No guardar el mensaje "Escribiendo"
      thinkingMsg.id = 'escribiendo-msg';

      try {
        console.log('ğŸ” Pregunta Chat:', pregunta);
        const textoRespuesta = await window.iaContextual.responder(pregunta);
        console.log('âœ… Respuesta Chat recibida:', textoRespuesta);
        thinkingMsg.innerHTML = limpiarMarkdown(textoRespuesta);
        thinkingMsg.id = '';
        guardarHistorialChat(); // Guardar la respuesta final
      } catch (e) {
        console.error('âŒ Error en chat:', e);
        thinkingMsg.innerHTML = 'âŒ Error al obtener respuesta.';
        thinkingMsg.id = '';
        guardarHistorialChat(); // Guardar el mensaje de error
      }
    }

    function guardarHistorialChat() {
      const chatMessages = document.getElementById('chat-messages');
      const historial = [];
      chatMessages.childNodes.forEach(msgDiv => {
        // No guardar el mensaje de "Escribiendo..." si aÃºn existe
        if (msgDiv.id === 'escribiendo-msg') return;
        
        historial.push({
          remitente: msgDiv.style.alignSelf === 'flex-end' ? 'user' : 'bot',
          mensaje: msgDiv.style.alignSelf === 'flex-end' ? msgDiv.textContent : msgDiv.innerHTML
        });
      });
      localStorage.setItem('historialChatViaria', JSON.stringify(historial));
    }

    function cargarHistorialChat() {
      const historial = JSON.parse(localStorage.getItem('historialChatViaria'));
      if (historial && historial.length) {
        historial.forEach(item => {
          agregarMensajeChat(item.mensaje, item.remitente, false);
        });
        return true;
      }
      return false;
    }

    document.getElementById('chat-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const input = document.getElementById('chat-input');
      const pregunta = input.value.trim();
      if (!pregunta) return;

      enviarPreguntaChat(pregunta);
      input.value = '';
    });

    // Carga el historial al iniciar
    document.addEventListener('DOMContentLoaded', ()=>{
      if (!cargarHistorialChat()) {
        // Si no hay historial, mostrar bienvenida
        setTimeout(() => {
          agregarMensajeChat('ğŸ‘‹ Â¡Hola! Soy ATRM. Â¿En quÃ© puedo ayudarte sobre el convenio o tus derechos laborales?', 'bot');
        }, 500);
      }

      // Selector de modos removido en nueva versiÃ³n de IA
    });
  </script>

  <div class="card" style="padding:24px">
      <h3>ğŸ—“ï¸ Calculadora de vacaciones y descansos</h3>
      <form id="formVacaciones" autocomplete="off" style="display:flex;flex-direction:column;gap:12px">
        <label><strong>Jornada anual (horas):</strong>
          <input type="number" id="jornadaInput" min="1000" max="2200" value="1792" required style="padding:8px;border-radius:8px;border:1px solid #ffd2b5;font-size:16px;width:100%">
        </label>
        <label><strong>DÃ­as trabajados al aÃ±o:</strong>
          <input type="number" id="diasInput" min="1" max="365" value="225" required style="padding:8px;border-radius:8px;border:1px solid #ffd2b5;font-size:16px;width:100%">
        </label>
        <button type="submit" class="btn">Calcular</button>
      </form>
      <div id="resultadoVacaciones" style="margin-top:14px;font-size:16px;color:#1976D2"></div>
      <div style="font-size:13px;color:#2C3E50;margin-top:8px">SegÃºn convenio: 30 dÃ­as naturales de vacaciones y descansos proporcionales a la jornada.</div>
    </div>

  <!-- Preloader Script (must load early) -->
  <script src="js/preloader-auto.js"></script>
  
  <!-- Premium Animations -->
  <script src="js/animations.js"></script>
  
  <!-- Scripts para nuevas funcionalidades -->
  <link rel="stylesheet" href="css/notificaciones.css">
  <link rel="stylesheet" href="css/telegram_widget.css">
  <script src="js/notificaciones.js"></script>
  <script src="js/telegram_widget.js"></script>
  <script src="js/christmas-auto.js"></script>
  <script src="js/pwa.js"></script>
</html>
