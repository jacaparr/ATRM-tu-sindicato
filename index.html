<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ATRM - Tu Sindicato</title>
  <style>
    :root{ --primary:#FF6B35; --secondary:#FF8C42; --accent:#FFA726; --dark:#2C3E50; --light:#FFFFFF; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;color:var(--dark);background:linear-gradient(180deg, #fff 0%, #fff7f0 100%)}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,var(--primary),var(--secondary));color:#fff}
    .nav{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:14px 20px}
    .logo{font-weight:800;letter-spacing:.3px}
    .menu a{color:#fff;text-decoration:none;margin:0 10px;padding:8px 12px;border-radius:10px;transition:.2s}
    .menu a:hover{background:rgba(255,255,255,.15)}

    /* Carrusel noticias */
    .news-carousel{background:linear-gradient(90deg,var(--primary),var(--secondary));color:#fff;padding:10px 0}
    .carousel-wrap{max-width:1100px;margin:0 auto;position:relative;padding:0 48px}
    .slides{display:flex;overflow:hidden;scroll-behavior:smooth}
    .slide{min-width:100%;padding:10px 0}
    .slide a{color:#fff;text-decoration:none}
    .title{font-weight:800}
    .dots{display:flex;gap:6px;justify-content:center;margin-top:6px}
    .dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.4);cursor:pointer}
    .dot.active{background:#fff}
    .arrow{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.2);border:none;color:#fff;width:34px;height:34px;border-radius:50%;cursor:pointer}
    .arrow:hover{background:rgba(255,255,255,.35)}
    .prev{left:10px}.next{right:10px}

    .hero{max-width:1100px;margin:28px auto;padding:24px 20px;display:grid;grid-template-columns:1.1fr .9fr;gap:28px}
    .card{background:#fff;border:1px solid #ffe2cf;border-radius:18px;box-shadow:0 10px 24px rgba(255,119,51,.08)}
    .hero .left{padding:28px}
    .badge{display:inline-block;background:linear-gradient(90deg,var(--secondary),var(--accent));color:#4e2b00;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700}
    h1{margin:10px 0 14px;font-size:36px}
    .cta{display:flex;gap:12px;margin-top:18px}
    .btn{background:linear-gradient(90deg,var(--primary),var(--secondary));border:none;color:#fff;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:700;text-decoration:none;display:inline-block;transition:.2s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(255,107,53,.3)}
    .btn.alt{background:#fff;color:var(--primary);border:2px solid var(--primary)}
    .news{padding:18px}
    .grid{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:repeat(3,1fr);gap:18px;padding:0 20px 40px}

    @media(max-width:900px){.hero{grid-template-columns:1fr}.grid{grid-template-columns:1fr}.carousel-wrap{padding:0 40px}}
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="logo">ATRM ¬∑ Tu Sindicato</div>
      <nav class="menu">
        <a href="#inicio">Inicio</a>
        <a href="#convenio">Convenio</a>
        <a href="salaries.html">Salarios</a>
        <a href="tramites.html">Tr√°mites</a>
        <a href="festivos.html">Informaci√≥n</a>
        <a href="#noticias">Noticias</a>
        <a href="#contacto">Contacto</a>
      </nav>
    </div>
  </header>

  <section class="news-carousel" id="newsTop">
    <div class="carousel-wrap">
      <button class="arrow prev" aria-label="Anterior" onclick="prevSlide()">‚Äπ</button>
      <div class="slides" id="slides">
        <div class="slide">
          <a href="https://www.facebook.com/share/v/1GpuUm99s3/" target="_blank" rel="noopener">
            <span class="title">üó∫Ô∏è Limpieza Mazarr√≥n</span> ‚Äî Ver noticia en Facebook
          </a>
        </div>
        <div class="slide" id="slideDynamic1"></div>
        <div class="slide" id="slideDynamic2"></div>
      </div>
      <button class="arrow next" aria-label="Siguiente" onclick="nextSlide()">‚Ä∫</button>
      <div class="dots" id="dots"></div>
    </div>
  </section>

  <main id="inicio" class="hero">
    <section class="left card">
      <span class="badge">Limpieza P√∫blica Viaria ¬∑ Regi√≥n de Murcia</span>
      <h1>Defendemos tus derechos con cercan√≠a y resultados</h1>
      <p>ATRM es el sindicato de referencia para los trabajadores de limpieza viaria y servicios municipales en la Regi√≥n de Murcia.</p>
      <div class="cta">
        <a class="btn" href="#convenio">Ver Convenio</a>
        <a class="btn alt" href="tramites.html">Tr√°mites</a>
      </div>
    </section>
    <aside class="card news" id="noticias">
      <h3>√öltimas noticias</h3>
      <div id="newsList"></div>
    </aside>
  </main>

  <section id="convenio" class="grid">
    <div class="card" style="padding:20px">
      <h3>Convenio Colectivo 2024‚Äì2027</h3>
      <p id="convenioResumen"></p>
      <ul id="convenioDatos"></ul>
      <button class="btn" onclick="abrirIA()">Preg√∫ntale a la IA sobre el convenio</button>
      <div id="vistaRespuesta" style="display:none;margin-top:12px"></div>
    </div>
    <div class="card" style="padding:20px">
      <h3>√Åmbito de aplicaci√≥n</h3>
      <p id="ambito"></p>
    </div>
    <div class="card" style="padding:20px">
      <h3>Documentaci√≥n</h3>
      <p>Accede a la tabla salarial y calendario de festivos 2026.</p>
      <a class="btn alt" href="festivos.html">Ver festivos 2026</a>
    </div>
    <div class="card" style="padding:20px;grid-column:1/-1">
      <h3>üìÇ Descarga de documentos</h3>
      <div style="display:flex;flex-wrap:wrap;gap:16px 24px;align-items:center">
        <a class="btn" href="assets/calendarios/calendario-descansos-2026.png" download="calendario-descansos-atrm-2026.png">üì• Calendario de descansos 2026</a>
        <a class="btn alt" href="salaries.html" target="_blank">üìä Tabla salarial 2025-2026</a>
        <a class="btn" href="https://www.borm.es/services/anuncio/ano/2025/numero/34/pdf?id=812345" target="_blank">üìÑ Convenio completo (BORM n¬∫ 34)</a>
      </div>
      <div style="margin-top:10px;font-size:13px;color:#666">Puedes descargar el calendario, la tabla salarial y el texto oficial del convenio sectorial.</div>
    </div>
  </section>

  <section id="contacto" class="grid">
    <div class="card" style="padding:20px;grid-column:1/-1">
      <h3>üö® Denuncia an√≥nima</h3>
      <form id="formDenuncia" autocomplete="off" style="display:flex;flex-wrap:wrap;gap:16px;flex-direction:column">
        <textarea name="denuncia" placeholder="Describe la situaci√≥n o irregularidad laboral (no pongas datos personales si quieres mantener el anonimato)" required rows="4" style="padding:10px;border-radius:8px;border:1px solid #ffd2b5;font-size:16px"></textarea>
        <button type="submit" class="btn" style="background:#e74c3c">Enviar denuncia an√≥nima</button>
        <div id="msgDenuncia" style="margin-top:8px;font-size:15px;display:none"></div>
      </form>
      <div style="font-size:13px;color:#666;margin-top:8px">Esta denuncia es confidencial y solo ser√° revisada por el sindicato. No se almacena ning√∫n dato personal salvo que lo incluyas voluntariamente.</div>
    </div>
    <div class="card" style="padding:20px">
      <h3>üìû Contacto</h3>
      <p><strong>Tel√©fono principal:</strong> 968 30 00 37 (Lunes Tarde)<br>
      <strong>Tel√©fono:</strong> 658 876 771<br>
      <strong>FAX:</strong> 968 30 00 37<br>
      <strong>Email:</strong> <a href="mailto:info@atrm-sindicato.es" style="color:var(--primary)">info@atrm-sindicato.es</a><br>
      <strong>Direcci√≥n:</strong> C/ Carril La Torre, 27 Bajo<br>30006 Puente Tocinos (MURCIA)</p>
    </div>
    <div class="card" style="padding:20px">
      <h3>üì± Contactos directos</h3>
      <p style="line-height:1.8">
        <strong>Andr√©s Andu√°:</strong> 696 446 421<br>
        <strong>Santiago Oliva:</strong> 609 314 582<br>
        <strong>Francisco S√°nchez (Suave):</strong> 628 304 954<br>
        <strong>Mesa:</strong> 658 876 771<br><br>
        <strong>Otros tel√©fonos:</strong><br>
        649 549 495<br>
        616 973 186 ¬∑ 653 878 579<br>
        635 457 212
      </p>
    </div>
    <div class="card" style="padding:20px">
      <h3>üïê Horario de atenci√≥n</h3>
      <p>Lunes a Viernes: 09:00 - 14:00<br>
      Lunes (Tarde): 16:00 - 20:00</p>
    </div>
    <div class="card" style="padding:20px;grid-column:1/-1;text-align:center">
      <h3>üîó Contacto y redes sociales</h3>
      <div style="display:flex;gap:18px;justify-content:center;flex-wrap:wrap;margin-bottom:10px">
        <a href="https://wa.me/34658876771?text=Hola%20ATRM%2C%20quisiera%20informaci%C3%B3n" target="_blank" class="btn" style="background:#25D366"><span style="font-size:20px">üü¢</span> WhatsApp</a>
        <a href="mailto:info@atrm-sindicato.es" class="btn alt" style="background:#fff;color:#FF6B35;border:2px solid #FF6B35"><span style="font-size:20px">‚úâÔ∏è</span> Email</a>
        <a href="https://www.facebook.com/share.php?u=https://jacaparr.github.io/ATRM-tu-sindicato/" target="_blank" class="btn" style="background:#4267B2"><span style="font-size:20px">üîµ</span> Facebook</a>
      </div>
      <div style="font-size:13px;color:#666">Contacta por WhatsApp, correo o comparte la web en Facebook.</div>
    </div>
    <div class="card" style="padding:20px;grid-column:1/-1">
      <h3>‚úâÔ∏è Formulario de contacto</h3>
      <form id="contactForm" autocomplete="on" style="display:flex;flex-wrap:wrap;gap:16px;flex-direction:column">
        <div style="display:flex;gap:16px;flex-wrap:wrap">
          <input name="nombre" type="text" placeholder="Nombre y apellidos" required style="flex:1;padding:10px;border-radius:8px;border:1px solid #ffd2b5;font-size:16px">
          <input name="email" type="email" placeholder="Correo electr√≥nico" required style="flex:1;padding:10px;border-radius:8px;border:1px solid #ffd2b5;font-size:16px">
          <input name="telefono" type="tel" placeholder="Tel√©fono (opcional)" style="flex:1;padding:10px;border-radius:8px;border:1px solid #ffd2b5;font-size:16px">
        </div>
        <textarea name="mensaje" placeholder="Escribe tu consulta o mensaje" required rows="4" style="padding:10px;border-radius:8px;border:1px solid #ffd2b5;font-size:16px"></textarea>
        <button type="submit" class="btn">Enviar mensaje</button>
        <div id="formMsg" style="margin-top:8px;font-size:15px;display:none"></div>
      </form>
    </div>
  </section>

  <dialog id="iaModal" style="max-width:820px;width:96%;border:none;border-radius:16px;padding:0;overflow:auto;max-height:85vh">
    <div style="padding:16px">
      <p>Asistente IA del convenio</p>
      <input id="preguntaIA" placeholder="Escribe tu pregunta" style="width:100%;padding:14px;border:1px solid #ffd2b5;border-radius:12px;font-size:16px" />
      <button id="btnPreguntar" class="btn" style="margin-top:12px" onclick="preguntarIA()">Preguntar</button>
      <div id="respuestaIA" style="margin-top:14px;display:none"></div>
      <div id="sugerenciasIA" style="display:none;margin-top:10px"></div>
    </div>
  </dialog>

  <script>
  // Formulario de denuncia an√≥nima
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('formDenuncia');
    if (form) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        const msg = document.getElementById('msgDenuncia');
        msg.textContent = '¬°Denuncia enviada de forma an√≥nima! El sindicato revisar√° la situaci√≥n.';
        msg.style.display = 'block';
        form.reset();
        setTimeout(()=>{msg.style.display='none';}, 6000);
      });
    }
  });
  // Cargar IA mejorada para el asistente del convenio
  const scriptIA = document.createElement('script');
  scriptIA.src = 'js/ia_mejorada.js';
  document.head.appendChild(scriptIA);

  function abrirIA(){
    document.getElementById('iaModal').showModal();
    document.getElementById('preguntaIA').focus();
  }

  async function preguntarIA() {
    const pregunta = document.getElementById('preguntaIA').value.trim();
    if (!pregunta) {
      alert('Por favor, escribe tu pregunta');
      return;
    }
    const btn = document.getElementById('btnPreguntar');
    const respuestaDiv = document.getElementById('respuestaIA');
    const sugDiv = document.getElementById('sugerenciasIA');
    btn.disabled = true;
    respuestaDiv.style.display = 'none';
    sugDiv.style.display = 'none';
    try {
      // Esperar a que la IA est√© cargada
      if (!window.iaContextual) {
        await new Promise(resolve => {
          const check = setInterval(() => {
            if (window.iaContextual) {
              clearInterval(check);
              resolve();
            }
          }, 100);
        });
      }
      const respuesta = await window.iaContextual.procesarMultiConsulta(pregunta);
      respuestaDiv.innerHTML = respuesta;
      respuestaDiv.style.display = 'block';
      // Renderizar chips de sugerencias si hay (omitido en modo estricto)
      if (window.iaContextual && !window.iaContextual.modoEstrict && typeof window.iaContextual.obtenerSugerencias === 'function') {
        const sugs = window.iaContextual.obtenerSugerencias();
        if (sugs && sugs.length) {
          const principalScore = (window.iaContextual.ultimosResultados && window.iaContextual.ultimosResultados[0]?.score) || 0;
          const titulo = document.createElement('div');
          titulo.textContent = principalScore < 6 ? 'Tambi√©n podr√≠an interesarte:' : 'Temas relacionados:';
          titulo.style.margin = '8px 0 6px';
          titulo.style.fontWeight = '700';
          const wrap = document.createElement('div');
          wrap.style.display = 'flex';
          wrap.style.flexWrap = 'wrap';
          wrap.style.gap = '8px';
          sugs.forEach(s => {
            const b = document.createElement('button');
            b.type = 'button';
            b.textContent = s.titulo;
            b.style.background = '#fff7f0';
            b.style.border = '1px solid #ffd2b5';
            b.style.color = '#2C3E50';
            b.style.padding = '6px 10px';
            b.style.borderRadius = '999px';
            b.style.cursor = 'pointer';
            b.style.fontSize = '13px';
            b.onclick = () => {
              const inp = document.getElementById('preguntaIA');
              inp.value = s.titulo;
              preguntarIA();
            };
            wrap.appendChild(b);
          });
          sugDiv.innerHTML = '';
          sugDiv.appendChild(titulo);
          sugDiv.appendChild(wrap);
          sugDiv.style.display = 'block';
        }
      }
    } catch (error) {
      respuestaDiv.innerHTML = '<div style="color:#e74c3c">‚ùå Error procesando la pregunta. Intenta de nuevo o contacta ATRM: 968 30 00 37</div>';
      respuestaDiv.style.display = 'block';
    } finally {
      btn.disabled = false;
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    const input = document.getElementById('preguntaIA');
    if (input) {
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') preguntarIA();
      });
    }
  });
  // Formulario de contacto ATRM
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('contactForm');
    if (form) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        // Aqu√≠ se puede integrar el env√≠o real por email (backend o servicio externo)
        // Por ahora solo muestra confirmaci√≥n visual
        const msg = document.getElementById('formMsg');
        msg.textContent = '¬°Mensaje enviado correctamente! Nos pondremos en contacto contigo pronto.';
        msg.style.display = 'block';
        form.reset();
        setTimeout(()=>{msg.style.display='none';}, 6000);
      });
    }
  });
    // Carga de algunas noticias para las slides din√°micas
    document.addEventListener('DOMContentLoaded', ()=>{
      const d1 = document.getElementById('slideDynamic1');
      const d2 = document.getElementById('slideDynamic2');
      d1.innerHTML = '<span class="title">üì∞ ATRM</span> ‚Äî Calendario laboral 2026 disponible';
      d2.innerHTML = '<span class="title">üì¢ ATRM</span> ‚Äî Tr√°mites y gu√≠as paso a paso actualizados';
      initDots();
    });
    let idx=0; function nextSlide(){ idx=(idx+1)%3; document.getElementById('slides').scrollTo({left:idx*document.getElementById('slides').clientWidth,behavior:'smooth'}); setActiveDot(); }
    function prevSlide(){ idx=(idx+2)%3; document.getElementById('slides').scrollTo({left:idx*document.getElementById('slides').clientWidth,behavior:'smooth'}); setActiveDot(); }
    function initDots(){ const dots=document.getElementById('dots'); for(let i=0;i<3;i++){ const b=document.createElement('div'); b.className='dot'+(i===0?' active':''); b.onclick=()=>{ idx=i; nextSlide(); }; dots.appendChild(b);} }
    function setActiveDot(){ const dots=[...document.querySelectorAll('.dot')]; dots.forEach((d,i)=>d.classList.toggle('active',i===idx)); }
  </script>
</body>
  <!-- Chat flotante estilo WhatsApp -->
  <div id="chat-float-btn" style="position:fixed;bottom:28px;right:28px;z-index:9999;">
    <button onclick="abrirChatATRM()" style="background:#25D366;color:#fff;border:none;border-radius:50%;width:60px;height:60px;box-shadow:0 4px 16px rgba(0,0,0,0.18);font-size:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;">
      üí¨
    </button>
  </div>
  <div id="chat-atm-window" style="display:none;position:fixed;bottom:100px;right:32px;width:340px;max-width:95vw;background:#fff;border-radius:18px;box-shadow:0 8px 32px rgba(0,0,0,0.18);z-index:10000;overflow:hidden;flex-direction:column;">
    <div style="background:#25D366;color:#fff;padding:14px 18px;font-weight:700;display:flex;align-items:center;justify-content:space-between;">
      <span>ATRM Chat</span>
      <button onclick="cerrarChatATRM()" style="background:none;border:none;color:#fff;font-size:22px;cursor:pointer;">√ó</button>
    </div>
    <div id="chat-messages" style="padding:14px;height:260px;overflow-y:auto;background:#f7f7f7;font-size:15px;display:flex;flex-direction:column;gap:8px;"></div>
    <form id="chat-form" style="display:flex;border-top:1px solid #eee;background:#fff">
      <input id="chat-input" type="text" placeholder="Escribe tu pregunta..." autocomplete="off" style="flex:1;padding:10px 12px;border:none;font-size:15px;border-radius:0 0 0 18px;outline:none">
      <button type="submit" style="background:#25D366;color:#fff;border:none;padding:0 18px;font-size:18px;cursor:pointer;border-radius:0 0 18px 0;">‚û§</button>
    </form>
  </div>
  <script>
    // Mensaje de bienvenida humano
    let chatBienvenidaMostrada = false;
    function abrirChatATRM(){
      document.getElementById('chat-atm-window').style.display = 'flex';
      setTimeout(()=>{
        const el = document.getElementById('chat-input');
        if(el) el.focus();
      }, 200);
      if (!chatBienvenidaMostrada) {
        agregarMensajeChat('üëã ¬°Hola! Soy ATRM. ¬øEn qu√© puedo ayudarte sobre el convenio o tus derechos laborales?', 'bot');
        chatBienvenidaMostrada = true;
      }
    }
    function cerrarChatATRM(){
      document.getElementById('chat-atm-window').style.display = 'none';
    }
    // L√≥gica de chat
    document.getElementById('chat-form').addEventListener('submit', async function(e){
      e.preventDefault();
      const input = document.getElementById('chat-input');
      const msg = input.value.trim();
      if(!msg) return;
      agregarMensajeChat(msg, 'user');
      input.value = '';
      // Frase de espera humana
      const frasesEspera = [
        'Un momento, estoy buscando la informaci√≥n... ü§î',
        'D√©jame revisar el convenio para darte la mejor respuesta...',
        'Consultando la base de datos sindical...'
      ];
      const frase = frasesEspera[Math.floor(Math.random()*frasesEspera.length)];
      agregarMensajeChat(frase, 'bot');
      // Esperar a que la IA est√© cargada
      if (!window.iaContextual) {
        await new Promise(resolve => {
          const check = setInterval(() => {
            if (window.iaContextual) {
              clearInterval(check);
              resolve();
            }
          }, 100);
        });
      }
      const respuesta = await window.iaContextual.procesarMultiConsulta(msg);
      quitarUltimoMensajeBot();
      // A√±adir saludo humano si la respuesta es gen√©rica
      let respuestaFinal = respuesta;
      if(respuesta.startsWith('ü§ñ')){
        respuestaFinal = 'üòä '+respuesta;
      }
      agregarMensajeChat(respuestaFinal, 'bot');
  if (!window.iaContextual?.modoEstrict) insertarSugerenciasChat();
    });
    function agregarMensajeChat(texto, tipo){
      const chat = document.getElementById('chat-messages');
      const div = document.createElement('div');
      div.style.maxWidth = '85%';
      div.style.alignSelf = tipo==='user'?'flex-end':'flex-start';
      div.style.background = tipo==='user'?'#e1ffc7':'#fff';
      div.style.color = '#222';
      div.style.padding = '8px 12px';
      div.style.borderRadius = tipo==='user'?'16px 16px 4px 16px':'16px 16px 16px 4px';
      div.style.boxShadow = '0 2px 8px rgba(0,0,0,0.04)';
      div.innerHTML = texto;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
    function quitarUltimoMensajeBot(){
      const chat = document.getElementById('chat-messages');
      for(let i=chat.children.length-1;i>=0;i--){
        if(chat.children[i].style.alignSelf==='flex-start'){
          chat.removeChild(chat.children[i]);
          break;
        }
      }
    }
    function insertarSugerenciasChat(){
      if (!window.iaContextual || window.iaContextual.modoEstrict || typeof window.iaContextual.obtenerSugerencias !== 'function') return;
      const sugs = window.iaContextual.obtenerSugerencias();
      if (!sugs || !sugs.length) return;
      const cont = document.createElement('div');
      cont.style.maxWidth = '85%';
      cont.style.alignSelf = 'flex-start';
      cont.style.background = '#fff';
      cont.style.color = '#222';
      cont.style.padding = '8px 12px';
      cont.style.borderRadius = '16px 16px 16px 4px';
      cont.style.boxShadow = '0 2px 8px rgba(0,0,0,0.04)';
      const principalScore = (window.iaContextual.ultimosResultados && window.iaContextual.ultimosResultados[0]?.score) || 0;
      const label = document.createElement('div');
      label.textContent = principalScore < 6 ? 'Tambi√©n podr√≠an interesarte:' : 'Temas relacionados:';
      label.style.fontWeight = '700';
      label.style.margin = '0 0 6px 0';
      const wrap = document.createElement('div');
      wrap.style.display = 'flex';
      wrap.style.flexWrap = 'wrap';
      wrap.style.gap = '6px';
      sugs.forEach(s => {
        const b = document.createElement('button');
        b.type = 'button';
        b.textContent = s.titulo;
        b.style.background = '#eaf6ff';
        b.style.border = '1px solid #bfe0ff';
        b.style.color = '#1f3b57';
        b.style.padding = '6px 10px';
        b.style.borderRadius = '999px';
        b.style.cursor = 'pointer';
        b.style.fontSize = '13px';
        b.onclick = () => {
          const inp = document.getElementById('chat-input');
          inp.value = s.titulo;
          document.getElementById('chat-form').dispatchEvent(new Event('submit', { bubbles:true, cancelable:true }));
        };
        wrap.appendChild(b);
      });
      cont.appendChild(label);
      cont.appendChild(wrap);
      const chat = document.getElementById('chat-messages');
      chat.appendChild(cont);
      chat.scrollTop = chat.scrollHeight;
    }
  </script>
  <script>
    function abrirChatATRM(){
      document.getElementById('chat-atm-window').style.display = 'flex';
      setTimeout(()=>{
        const el = document.getElementById('chat-input');
        if(el) el.focus();
      }, 200);
    }
    function cerrarChatATRM(){
      document.getElementById('chat-atm-window').style.display = 'none';
    }
    // L√≥gica de chat
    document.getElementById('chat-form').addEventListener('submit', async function(e){
      e.preventDefault();
      const input = document.getElementById('chat-input');
      const msg = input.value.trim();
      if(!msg) return;
      agregarMensajeChat(msg, 'user');
      input.value = '';
      agregarMensajeChat('...', 'bot');
      // Esperar a que la IA est√© cargada
      if (!window.iaContextual) {
        await new Promise(resolve => {
          const check = setInterval(() => {
            if (window.iaContextual) {
              clearInterval(check);
              resolve();
            }
          }, 100);
        });
      }
      const respuesta = await window.iaContextual.procesarMultiConsulta(msg);
      quitarUltimoMensajeBot();
      agregarMensajeChat(respuesta, 'bot');
    });
    function agregarMensajeChat(texto, tipo){
      const chat = document.getElementById('chat-messages');
      const div = document.createElement('div');
      div.style.maxWidth = '85%';
      div.style.alignSelf = tipo==='user'?'flex-end':'flex-start';
      div.style.background = tipo==='user'?'#e1ffc7':'#fff';
      div.style.color = '#222';
      div.style.padding = '8px 12px';
      div.style.borderRadius = tipo==='user'?'16px 16px 4px 16px':'16px 16px 16px 4px';
      div.style.boxShadow = '0 2px 8px rgba(0,0,0,0.04)';
      div.innerHTML = texto;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
    function quitarUltimoMensajeBot(){
      const chat = document.getElementById('chat-messages');
      for(let i=chat.children.length-1;i>=0;i--){
        if(chat.children[i].style.alignSelf==='flex-start'){
          chat.removeChild(chat.children[i]);
          break;
        }
      }
    }
  </script>
</html>